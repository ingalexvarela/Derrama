<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Visor Mapillary con Streetview (GitHub Pages)</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
    
    <link href='https://unpkg.com/maplibre-gl@4.1.2/dist/maplibre-gl.css' rel='stylesheet' />
    
    <link href='https://unpkg.com/mapillary-js@4.1.0/dist/mapillary.css' rel='stylesheet' />
    
    <style>
        /* Estilos CSS para el layout de dos paneles (Mapa y Visor) */
        body { margin: 0; padding: 0; font-family: sans-serif; }
        #map { 
            position: absolute; 
            top: 0; 
            bottom: 0; 
            left: 0; 
            width: 60%; /* 60% de la pantalla para el mapa */
        }
        #viewer { 
            position: absolute; 
            top: 0; 
            bottom: 0; 
            right: 0; 
            width: 40%; /* 40% de la pantalla para el visor 360 */
            background-color: #222; /* Fondo oscuro mientras carga la imagen */
        }
        /* Estilo para mostrar una indicación sobre el visor */
        #loading-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            z-index: 10;
            text-align: center;
            font-size: 1.2em;
        }
    </style>
</head>
<body>

    <div id="map"></div>
    
    <div id="viewer">
        <div id="loading-message">
            Haga clic en un punto azul del mapa para iniciar el Streetview.
        </div>
    </div>

    <script src='https://unpkg.com/maplibre-gl@4.1.2/dist/maplibre-gl.js'></script>
    <script src='https://unpkg.com/mapillary-js@4.1.0/dist/mapillary.js'></script>

    <script>
        // =========================================================
        // CONFIGURACIÓN DE MAPILLARY Y MAPA
        // =========================================================
        const MAPILLARY_CLIENT_ID_NUMBER = "32604000689248347"; 
        const MAPILLARY_ACCESS_TOKEN = "MLY|32604000689248347|a7e69b278675ea3dee618791563ad6ef";
        
        // Coordenadas de ejemplo (San José, Costa Rica)
        const DEFAULT_CENTER = [-84.07, 9.93]; 
        const DEFAULT_ZOOM = 14; 
        
        // Elemento para mostrar el mensaje
        const loadingMessage = document.getElementById('loading-message');
        // =========================================================

        // 1. Inicializar el Mapa (MapLibre GL)
        const map = new maplibregl.Map({
            container: 'map',
            style: 'https://demotiles.maplibre.org/style.json',
            center: DEFAULT_CENTER,
            zoom: DEFAULT_ZOOM
        });

        // 2. Inicializar el Visor Inmersivo (Mapillary JS)
        const viewer = new mapillary.Viewer({
            container: 'viewer',
            accessToken: MAPILLARY_ACCESS_TOKEN,
            component: { 
                cover: false,      // No necesitamos la pantalla de carga de Mapillary, usamos la nuestra
                zoom: false,       // Simplificar controles
                direction: false,  // Simplificar controles
                sequence: false,   // Simplificar controles
                attribution: true
            }
        });

        // Ocultar el mensaje de inicio cuando el visor comienza a cargar algo
        viewer.on(mapillary.Viewer.loadingchanged, (isLoading) => {
             loadingMessage.style.display = isLoading ? 'none' : 'block';
        });

        map.on('load', () => {
            // 3. AGREGAR LA FUENTE DE DATOS DE MAPILLARY (Cobertura)
            map.addSource('mapillary', {
                type: 'vector',
                url: 'https://tiles.mapillary.com/maps/v2/vector_tiles/v2.0/tiles/{z}/{x}/{y}/?client_id=' + MAPILLARY_CLIENT_ID_NUMBER
            });

            // 4. AGREGAR LA CAPA VISUAL DE LOS PUNTOS DE COBERTURA
            map.addLayer({
                id: 'mapillary-coverage',
                type: 'circle',
                source: 'mapillary',
                'source-layer': 'mapillary_feature_point',
                paint: {
                    'circle-color': '#00BFFF',
                    'circle-opacity': 0.8,
                    'circle-radius': 4
                }
            });

            // 5. FUNCIÓN DE "STREETVIEW" AL HACER CLIC
            map.on('click', 'mapillary-coverage', (e) => {
                const feature = e.features[0];
                const imageKey = feature.properties.key; 

                if (imageKey) {
                    loadingMessage.style.display = 'none'; // Ocultar mensaje antes de la carga
                    // Mover el visor a la imagen 360 inmersiva
                    viewer.moveTo(imageKey)
                        .then(() => {
                            // Centrar el mapa en el punto clickeado
                            map.flyTo({ center: e.lngLat, zoom: 16 });
                        })
                        .catch((error) => {
                            console.error("Error al cargar la imagen de Mapillary:", error);
                            loadingMessage.innerText = "Error al cargar la imagen. Intente de nuevo.";
                            loadingMessage.style.display = 'block';
                        });
                }
            });

            // 6. MEJORA DE UX: CAMBIAR EL CURSOR
            map.on('mouseenter', 'mapillary-coverage', () => {
                map.getCanvas().style.cursor = 'pointer';
            });
            map.on('mouseleave', 'mapillary-coverage', () => {
                map.getCanvas().style.cursor = '';
            });
        });

    </script>
</body>
</html>
