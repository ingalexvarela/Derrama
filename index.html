<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Visor Mapillary Streetview - FINAL</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
    
    <link href='https://unpkg.com/maplibre-gl@4.1.2/dist/maplibre-gl.css' rel='stylesheet' />
    
    <link href='https://unpkg.com/mapillary-js@4.1.0/dist/mapillary.css' rel='stylesheet' />
    
    <style>
        /* Estilos CSS para el layout de dos paneles (Mapa y Visor) */
        body { margin: 0; padding: 0; font-family: sans-serif; }
        #map { 
            position: absolute; 
            top: 0; 
            bottom: 0; 
            left: 0; 
            width: 60%; /* 60% de la pantalla para el mapa */
        }
        #viewer { 
            position: absolute; 
            top: 0; 
            bottom: 0; 
            right: 0; 
            width: 40%; /* 40% de la pantalla para el visor 360 */
            background-color: #222; 
        }
        #loading-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            z-index: 10;
            text-align: center;
            font-size: 1.2em;
        }
    </style>
</head>
<body>

    <div id="map"></div>
    
    <div id="viewer">
        <div id="loading-message">
            Haga clic en una línea de secuencia roja del mapa para iniciar el Streetview.
        </div>
    </div>

    <script src='https://unpkg.com/maplibre-gl@4.1.2/dist/maplibre-gl.js'></script>
    <script src='https://unpkg.com/mapillary-js@4.1.0/dist/mapillary.js'></script>

    <script>
        // =========================================================
        // CONFIGURACIÓN DE MAPILLARY Y MAPA
        // =========================================================
        // ACCESS TOKEN (Token completo) -> Necesario para los tiles y el visor
        const MAPILLARY_ACCESS_TOKEN = "MLY|32604000689248347|a7e69b278675ea3dee618791563ad6ef";
        
        // Coordenadas de ejemplo (San José, Costa Rica)
        const DEFAULT_CENTER = [-84.07, 9.93]; 
        const DEFAULT_ZOOM = 14; 
        
        const loadingMessage = document.getElementById('loading-message');
        // =========================================================

        // 1. Inicializar el Mapa (MapLibre GL)
        const map = new maplibregl.Map({
            container: 'map',
            style: 'https://demotiles.maplibre.org/style.json', 
            center: DEFAULT_CENTER,
            zoom: DEFAULT_ZOOM
        });

        // 2. Inicializar el Visor Inmersivo (Mapillary JS)
        const viewer = new mapillary.Viewer({
            container: 'viewer',
            accessToken: MAPILLARY_ACCESS_TOKEN, // Usa el token completo
            component: { 
                cover: false, 
                zoom: false,       
                direction: false,  
                sequence: false,   
                attribution: true
            }
        });

        // Evento para ocultar/mostrar el mensaje de inicio
        viewer.on(mapillary.Viewer.loadingchanged, (isLoading) => {
             loadingMessage.style.display = isLoading ? 'none' : 'block';
        });

        map.on('load', () => {
            // 3. AGREGAR LA FUENTE DE DATOS DE MAPILLARY
            // *** USANDO EL ENDPOINT QUE SÍ FUNCIONÓ con ACCESS_TOKEN ***
            map.addSource('mapillary', {
                type: 'vector',
                tiles: ['https://tiles.mapillary.com/maps/vtp/mly1_public/2/{z}/{x}/{y}?access_token=' + MAPILLARY_ACCESS_TOKEN],
                minzoom: 0,
                maxzoom: 14
            });

            // 4. AGREGAR LA CAPA VISUAL DE LAS SECUENCIAS (LÍNEAS ROJAS)
            map.addLayer({
                id: 'mapillary-sequences',
                type: 'line',
                source: 'mapillary',
                'source-layer': 'sequence', // Capa de secuencias
                paint: {
                    'line-color': '#ff0000', // Líneas rojas visibles
                    'line-opacity': 0.9,
                    'line-width': 3
                }
            });

            // 5. FUNCIÓN DE "STREETVIEW" AL HACER CLIC
            // Escucha el clic en la capa de SECUENCIAS
            map.on('click', 'mapillary-sequences', (e) => {
                const feature = e.features[0];
                
                // Los tiles de secuencia contienen la clave de la primera imagen de la secuencia.
                const imageKey = feature.properties.first_image_key || feature.properties.key; 

                if (imageKey) {
                    loadingMessage.style.display = 'none'; 
                    // Mover el visor a la imagen 360 inmersiva
                    viewer.moveTo(imageKey)
                        .then(() => {
                            // Centrar el mapa en el punto clickeado
                            map.flyTo({ center: e.lngLat, zoom: 16 });
                        })
                        .catch((error) => {
                            console.error("Error al cargar la imagen de Mapillary:", error);
                            loadingMessage.innerText = "Error al cargar la imagen. Intente de nuevo.";
                            loadingMessage.style.display = 'block';
                        });
                } else {
                     console.log("Error: No se encontró la clave de imagen en la secuencia.");
                }
            });

            // 6. MEJORA DE UX: CAMBIAR EL CURSOR
            map.on('mouseenter', 'mapillary-sequences', () => {
                map.getCanvas().style.cursor = 'pointer';
            });
            map.on('mouseleave', 'mapillary-sequences', () => {
                map.getCanvas().style.cursor = '';
            });
        });

    </script>
</body>
</html>
